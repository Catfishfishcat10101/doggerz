rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Dogs collection: doc id MUST be the owner's UID
    match /dogs/{uid} {

      allow read: if request.auth != null && request.auth.uid == uid;

      allow create: if request.auth != null
        && request.auth.uid == uid
        && !exists(/databases/$(database)/documents/dogs/$(uid)) // one dog per user
        && isValidNewDog();

      allow update: if request.auth != null
        && request.auth.uid == uid
        && isValidDogUpdate();

      allow delete: if request.auth != null && request.auth.uid == uid;

      function isValidNewDog() {
        return request.resource.data.keys().hasAll(['ownerId','stats','mood','createdAt','updatedAt'])
          && request.resource.data.ownerId == uid
          && request.resource.data.stats.hunger is number
          && request.resource.data.stats.energy is number
          && request.resource.data.stats.cleanliness is number
          && request.resource.data.stats.hunger >= 0 && request.resource.data.stats.hunger <= 100
          && request.resource.data.stats.energy >= 0 && request.resource.data.stats.energy <= 100
          && request.resource.data.stats.cleanliness >= 0 && request.resource.data.stats.cleanliness <= 100;
      }

      function isValidDogUpdate() {
        // Name optional but constrained if present
        return (!('name' in request.resource.data) ||
                (request.resource.data.name is string &&
                 request.resource.data.name.size() >= 1 &&
                 request.resource.data.name.size() <= 24 &&
                 request.resource.data.name.matches('^[\\p{L}\\p{N} .,\'-]{1,24}$')))
          && (!('stats' in request.resource.data) ||
              (request.resource.data.stats.hunger is number &&
               request.resource.data.stats.energy is number &&
               request.resource.data.stats.cleanliness is number &&
               request.resource.data.stats.hunger >= 0 && request.resource.data.stats.hunger <= 100 &&
               request.resource.data.stats.energy >= 0 && request.resource.data.stats.energy <= 100 &&
               request.resource.data.stats.cleanliness >= 0 && request.resource.data.stats.cleanliness <= 100));
      }
    }
  }
}
