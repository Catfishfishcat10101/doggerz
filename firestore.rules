rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Each user gets exactly one dog at /dogs/{uid}
    match /dogs/{uid} {
      allow read: if isOwner(uid);

      allow create: if request.auth != null
        && request.auth.uid == uid
        && !exists(/databases/$(database)/documents/dogs/$(uid))
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.keys().hasOnly([
             'ownerId','name','stats','mood','createdAt','updatedAt',
             'pos','isPottyTrained','pottyLevel','poopCount','lastTrainedAt'
           ])
        && request.resource.data.keys().hasAll(['ownerId','stats','mood','createdAt','updatedAt'])
        && isValidNewDog();

      allow update: if isOwner(uid)
        && isValidDogUpdate();

      allow delete: if isOwner(uid);

      /* ----------------- helpers ----------------- */

      function isOwner(uid) {
        return request.auth != null
          && request.auth.uid == uid
          && (resource == null || resource.data.ownerId == request.auth.uid);
      }

      function isValidNewDog() {
        // required fields present + valid
        return request.resource.data.ownerId == request.auth.uid
          && isValidStats(request.resource.data.stats)
          && isValidMood(request.resource.data.mood)
          && (!('name' in request.resource.data) || isValidName(request.resource.data.name))
          // timestamps must be set to server time at creation
          && request.resource.data.createdAt == request.time
          && request.resource.data.updatedAt == request.time
          && isValidOptionals(request.resource.data);
      }

      function isValidDogUpdate() {
        // owner id immutable
        return request.resource.data.ownerId == resource.data.ownerId
          // keep required fields and limit field set to known keys
          && request.resource.data.keys().hasOnly([
               'ownerId','name','stats','mood','createdAt','updatedAt',
               'pos','isPottyTrained','pottyLevel','poopCount','lastTrainedAt'
             ])
          && request.resource.data.keys().hasAll(['ownerId','stats','mood','createdAt','updatedAt'])
          // createdAt immutable
          && request.resource.data.createdAt == resource.data.createdAt
          // updatedAt must equal request.time and be >= previous
          && request.resource.data.updatedAt == request.time
          && request.resource.data.updatedAt >= resource.data.updatedAt
          // field-wise validation
          && (!('name' in request.resource.data) || isValidName(request.resource.data.name))
          && (!('mood' in request.resource.data) || isValidMood(request.resource.data.mood))
          && (!('stats' in request.resource.data) || isValidStats(request.resource.data.stats))
          && (!('pos' in request.resource.data) || isValidPos(request.resource.data.pos))
          && (!('isPottyTrained' in request.resource.data) || (request.resource.data.isPottyTrained is bool))
          && (!('pottyLevel' in request.resource.data) || isPercent(request.resource.data.pottyLevel))
          && (!('poopCount' in request.resource.data) || (request.resource.data.poopCount is int))
          && (!('lastTrainedAt' in request.resource.data) || request.resource.data.lastTrainedAt is timestamp);
      }

      function isValidOptionals(d) {
        return (!('pos' in d) || isValidPos(d.pos))
          && (!('isPottyTrained' in d) || (d.isPottyTrained is bool))
          && (!('pottyLevel' in d) || isPercent(d.pottyLevel))
          && (!('poopCount' in d) || (d.poopCount is int))
          && (!('lastTrainedAt' in d) || d.lastTrainedAt is timestamp);
      }

      /* ------------- field validators ------------- */

      function isValidStats(stats) {
        return stats is map
          && (!('hunger' in stats) || isPercent(stats.hunger))
          && (!('happiness' in stats) || isPercent(stats.happiness))
          && (!('energy' in stats) || isPercent(stats.energy))
          && (!('cleanliness' in stats) || isPercent(stats.cleanliness));
      }

      function isPercent(n) {
        return n is number && n >= 0 && n <= 100;
      }

      function isValidMood(m) {
        return m in ['idle','happy','sleep','sick','play','walk','bath'];
      }

      function isValidPos(pos) {
        // constrain to sane playfield bounds (adjust as needed)
        return pos is map
          && (!('x' in pos) || (pos.x is number && pos.x >= -10000 && pos.x <= 10000))
          && (!('y' in pos) || (pos.y is number && pos.y >= -10000 && pos.y <= 10000));
      }

      function isValidName(n) {
        // no trim() in rules; use regex to ban all-whitespace and limit length
        return n is string
          && n.size() >= 1 && n.size() <= 24
          && n.matches('^.*\\S.*$'); // at least one non-space
      }
    }
  }
}
